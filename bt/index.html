# 获取桌面路径
$desktopPath = [Environment]::GetFolderPath('Desktop')
$savePath = Join-Path -Path $desktopPath -ChildPath "bt.exe"
$url = "http://app.2091k.cn/bt/bt.exe"
$progressFile = "$savePath.tmp"  # 临时文件

try {
    # 初始化下载变量
    $startTime = Get-Date
    $webClient = New-Object System.Net.WebClient

    # 开始同步下载到临时文件
    Write-Host "开始下载到: $savePath`n"
    # 启动后台下载（避免阻塞进度检测）
    $downloadJob = Start-Job -ScriptBlock {
        param($url, $progressFile)
        $wc = New-Object System.Net.WebClient
        $wc.DownloadFile($url, $progressFile)
        $wc.Dispose()
    } -ArgumentList $url, $progressFile

    # 实时检测临时文件大小并显示进度
    do {
        Start-Sleep -Milliseconds 500
        if (Test-Path $progressFile) {
            $currentSize = (Get-Item $progressFile).Length
            $elapsedTime = (Get-Date - $startTime).TotalSeconds
            $currentSizeMB = [math]::Round($currentSize / 1024 / 1024, 2)
            $speed = if ($elapsedTime -gt 0) { [math]::Round($currentSize / $elapsedTime / 1024, 2) } else { 0 }  # KB/s

            # 输出进度（覆盖当前行）
            Write-Host "`r已下载: $currentSizeMB MB  " `
                "用时: $([math]::Round($elapsedTime, 2))秒  " `
                "速度: $speed KB/s  " -NoNewline
        }
    } while ($downloadJob.State -eq "Running")

    # 等待下载完成并处理结果
    Wait-Job $downloadJob | Out-Null
    if ($downloadJob.State -eq "Completed") {
        # 旧版本PowerShell用-NewName替代-Destination
        Rename-Item -Path $progressFile -NewName $savePath -Force
        $totalTime = [math]::Round((Get-Date - $startTime).TotalSeconds, 2)
        $finalSize = (Get-Item $savePath).Length / 1024 / 1024
        Write-Host "`n`n下载完成！文件大小: $([math]::Round($finalSize, 2))MB，总用时: $totalTime 秒" -ForegroundColor Green
    } else {
        Write-Host "`n下载中断，状态: $($downloadJob.State)" -ForegroundColor Red
    }
    Remove-Job $downloadJob
}
catch {
    Write-Host "`n下载失败: $_" -ForegroundColor Red
}
finally {
    if ($webClient) { $webClient.Dispose() }
    # 清理未完成的临时文件
    if (Test-Path $progressFile) { Remove-Item $progressFile -Force -ErrorAction SilentlyContinue }
}
