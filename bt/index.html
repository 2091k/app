# 获取桌面路径
$desktopPath = [Environment]::GetFolderPath('Desktop')
$savePath = Join-Path -Path $desktopPath -ChildPath "bt.exe"
$url = "http://app.2091k.cn/bt/bt.exe"

try {
    # 创建Web请求获取文件总大小
    $request = [System.Net.HttpWebRequest]::Create($url)
    $request.Method = "HEAD"
    $response = $request.GetResponse()
    $totalSize = $response.ContentLength
    $response.Dispose()

    if ($totalSize -le 0) {
        Write-Host "无法获取文件大小，将继续下载..." -ForegroundColor Yellow
    }

    # 初始化下载变量
    $startTime = Get-Date
    $webClient = New-Object System.Net.WebClient
    $progressFile = "$savePath.tmp"  # 临时文件，避免下载中断污染目标文件

    # 同步下载（带进度计算）
    Write-Host "开始下载到: $savePath`n"
    $webClient.DownloadFile($url, $progressFile)

    # 下载过程中实时计算进度（通过临时文件大小）
    while (-not (Test-Path $progressFile) -or (Get-Item $progressFile).Length -lt $totalSize) {
        if (Test-Path $progressFile) {
            $currentSize = (Get-Item $progressFile).Length
            $elapsedTime = (Get-Date - $startTime).TotalSeconds
            $progress = if ($totalSize -gt 0) { [math]::Round(($currentSize / $totalSize) * 100, 2) } else { -1 }
            $speed = if ($elapsedTime -gt 0) { [math]::Round($currentSize / $elapsedTime / 1024, 2) } else { 0 }  # KB/s
            $currentSizeMB = [math]::Round($currentSize / 1024 / 1024, 2)
            $totalSizeMB = if ($totalSize -gt 0) { [math]::Round($totalSize / 1024 / 1024, 2) } else { "未知" }

            # 输出进度（覆盖当前行）
            Write-Host "`r进度: $(if ($progress -ne -1) {"$progress%"} else {"..."})  " `
                "已下载: $currentSizeMB MB / 总大小: $totalSizeMB MB  " `
                "用时: $([math]::Round($elapsedTime, 2))秒  " `
                "速度: $speed KB/s  " -NoNewline
        }
        Start-Sleep -Milliseconds 500
    }

    # 下载完成后重命名临时文件
    if (Test-Path $progressFile) {
        Rename-Item -Path $progressFile -Destination $savePath -Force
    }

    $totalTime = [math]::Round((Get-Date - $startTime).TotalSeconds, 2)
    Write-Host "`n`n下载完成！文件已保存到桌面，总用时: $totalTime 秒" -ForegroundColor Green
}
catch {
    Write-Host "`n下载失败: $_" -ForegroundColor Red
    # 清理临时文件
    if (Test-Path $progressFile) { Remove-Item $progressFile -Force }
}
finally {
    if ($webClient) { $webClient.Dispose() }
}
