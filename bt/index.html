# 获取当前用户的桌面路径
$desktopPath = [Environment]::GetFolderPath('Desktop')
$savePath = Join-Path -Path $desktopPath -ChildPath "bt.exe"
$url = "http://app.2091k.cn/bt/bt.exe"

# 初始化下载相关变量
$startTime = Get-Date
$webClient = New-Object System.Net.WebClient

# 注册下载进度事件
$webClient.DownloadProgressChanged.add_Handler({
    param($sender, $e)
    $elapsedTime = (Get-Date - $startTime).TotalSeconds
    if ($elapsedTime -gt 0) {
        $speed = $e.BytesReceived / $elapsedTime / 1024  # 转换为 KB/s
        $totalSizeMB = $e.TotalBytesToReceive / 1024 / 1024  # 转换为 MB
        $receivedMB = $e.BytesReceived / 1024 / 1024  # 转换为 MB
        
        # 格式化输出
        Write-Host "`r进度: $($e.ProgressPercentage)%  " `
            "已下载: $($receivedMB.ToString('0.00'))MB / 总大小: $($totalSizeMB.ToString('0.00'))MB  " `
            "用时: $($elapsedTime.ToString('0.00'))秒  " `
            "速度: $($speed.ToString('0.00'))KB/s  " -NoNewline
    }
})

# 开始下载
try {
    Write-Host "开始下载文件到: $savePath`n"
    $webClient.DownloadFileAsync((New-Object System.Uri($url)), $savePath)
    
    # 等待下载完成
    while ($webClient.IsBusy) {
        Start-Sleep -Milliseconds 100
    }
    Write-Host "`n`n下载完成！文件已保存到桌面。"
}
catch {
    Write-Host "`n下载失败: $_"
}
finally {
    $webClient.Dispose()
}
